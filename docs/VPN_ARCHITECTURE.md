# XrayHarmony VPN æ¶æ„è¯´æ˜

## æ¶æ„è®¾è®¡

XrayHarmony VPN åŠŸèƒ½é‡‡ç”¨**åˆ†ç¦»å¼æ¶æ„**ï¼Œé¿å…ä¾èµ–å†²çªï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HarmonyOS åº”ç”¨å±‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  VpnExtensionAbility                 â”‚  â”‚
â”‚  â”‚  - åˆ›å»º TUN è®¾å¤‡                      â”‚  â”‚
â”‚  â”‚  - è·å– TUN æ–‡ä»¶æè¿°ç¬¦ (fd)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â”€> TUN fd
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   tun2socks        â”‚  â”‚  Xray-core   â”‚ â”‚
â”‚  â”‚   (ç‹¬ç«‹è¿›ç¨‹/åº“)     â”‚â”€â”€>â”‚  SOCKS5å…¥ç«™  â”‚ â”‚
â”‚  â”‚                    â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  - æ¥æ”¶ TUN fd     â”‚  â”‚  - ä»£ç†å‡ºç«™  â”‚ â”‚
â”‚  â”‚  - SOCKS5 å®¢æˆ·ç«¯   â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚
â”‚         Native å±‚ (åˆ†ç¦»éƒ¨ç½²)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
       ç½‘ç»œæµé‡ä»£ç†
```

## ä¸ºä»€ä¹ˆé‡‡ç”¨åˆ†ç¦»å¼æ¶æ„ï¼Ÿ

### æ ¸å¿ƒé—®é¢˜

**Xray-core æœ¬èº«ä¸æ”¯æŒ TUN å…¥ç«™**ï¼š
- Xray-core åªæä¾›å„ç§ä»£ç†åè®®ï¼ˆSOCKS5ã€VMessã€VLESS ç­‰ï¼‰
- ä¸åŒ…å« TUN è®¾å¤‡çš„ç½‘ç»œæ ˆå¤„ç†èƒ½åŠ›
- éœ€è¦é¢å¤–çš„ç»„ä»¶æ¥å¤„ç† TUN æµé‡

### ä¾èµ–å†²çªé—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

å†å²ä¸Šå­˜åœ¨çš„é—®é¢˜ï¼š
1. **tun2socks** ä¾èµ–æ–°ç‰ˆæœ¬ gvisor
2. **Xray-core v1.8.16** ä¾èµ–æ—§ç‰ˆæœ¬ gvisor
3. åœ¨åŒä¸€ä¸ª Go æ¨¡å—ä¸­æ— æ³•åŒæ—¶ç¼–è¯‘

**å½“å‰çŠ¶æ€**ï¼ˆv1.251202.0ï¼‰ï¼š
- âœ… gvisor ä¾èµ–å†²çªå·²è§£å†³
- âœ… Xray-core å’Œ tun2socks å¯ä»¥ä½¿ç”¨å…¼å®¹çš„ gvisor ç‰ˆæœ¬
- âš ï¸ ä½†ä»éœ€åˆ†ç¦»å¼æ¶æ„ï¼Œå› ä¸º Xray-core æœ¬èº«ä¸æ”¯æŒ TUN

## XrayHarmony çš„èŒè´£

XrayHarmony ä¸“æ³¨äºï¼š

1. **å°è£… Xray-core**ï¼šæä¾›å®Œæ•´çš„ Xray ä»£ç†åŠŸèƒ½
2. **SOCKS5 å…¥ç«™**ï¼šç›‘å¬æœ¬åœ°ç«¯å£ï¼ˆå¦‚ 10808ï¼‰
3. **ä»£ç†ç®¡ç†**ï¼šé…ç½®ã€å¯åŠ¨ã€åœæ­¢ã€ç»Ÿè®¡

**ä¸åŒ…å«**ï¼š
- TUN è®¾å¤‡ç®¡ç†ï¼ˆç”± HarmonyOS VpnExtensionAbility å¤„ç†ï¼‰
- TUN æµé‡è½¬å‘ï¼ˆéœ€è¦ç‹¬ç«‹çš„ tun2socks æˆ–ç±»ä¼¼ç»„ä»¶ï¼‰

## å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ç‹¬ç«‹çš„ tun2socks äºŒè¿›åˆ¶ï¼ˆæ¨èï¼‰

1. **ç¼–è¯‘ tun2socks**
   ```bash
   git clone https://github.com/xjasonlyu/tun2socks
   cd tun2socks
   GOOS=linux GOARCH=arm64 go build -o tun2socks
   ```

2. **åœ¨ HarmonyOS åº”ç”¨ä¸­éƒ¨ç½²**
   - å°† tun2socks äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…åˆ°åº”ç”¨ä¸­
   - é€šè¿‡è¿›ç¨‹å¯åŠ¨æ–¹å¼è¿è¡Œ

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨é¢„ç¼–è¯‘çš„ tun2socks åº“

1. ä» [tun2socks releases](https://github.com/xjasonlyu/tun2socks/releases) ä¸‹è½½é¢„ç¼–è¯‘çš„åº“
2. é›†æˆåˆ° HarmonyOS é¡¹ç›®
3. é€šè¿‡ FFI æˆ–è¿›ç¨‹æ–¹å¼è°ƒç”¨

### æ–¹æ¡ˆ Cï¼šä½¿ç”¨å…¶ä»– TUN å¤„ç†æ–¹æ¡ˆ

å¯ä»¥ä½¿ç”¨å…¶ä»–æ”¯æŒ TUN -> SOCKS5 è½¬å‘çš„å·¥å…·æˆ–è‡ªå·±å®ç°ã€‚

## é…ç½®ç¤ºä¾‹

### Xray é…ç½®ï¼ˆå¿…é¡»åŒ…å« SOCKS5 å…¥ç«™ï¼‰

```json
{
  "inbounds": [
    {
      "tag": "socks-in",
      "port": 10808,
      "listen": "127.0.0.1",
      "protocol": "socks",
      "settings": {
        "auth": "noauth",
        "udp": true
      },
      "sniffing": {
        "enabled": true,
        "destOverride": ["http", "tls"]
      }
    }
  ],
  "outbounds": [
    {
      "tag": "proxy",
      "protocol": "vmess",
      "settings": {
        "vnext": [{
          "address": "your.server.com",
          "port": 443,
          "users": [{ "id": "your-uuid" }]
        }]
      }
    },
    {
      "tag": "direct",
      "protocol": "freedom"
    }
  ],
  "routing": {
    "rules": [
      {
        "type": "field",
        "ip": ["geoip:private", "geoip:cn"],
        "outboundTag": "direct"
      },
      {
        "type": "field",
        "domain": ["geosite:cn"],
        "outboundTag": "direct"
      }
    ]
  }
}
```

### tun2socks å¯åŠ¨å‚æ•°

```bash
tun2socks \
  -device fd://<tunFd> \
  -proxy socks5://127.0.0.1:10808 \
  -mtu 1400 \
  -loglevel info
```

### HarmonyOS VPN å¯åŠ¨æµç¨‹

```typescript
// 1. å¯åŠ¨ Xray (SOCKS5 å…¥ç«™åœ¨ 127.0.0.1:10808)
const xrayClient = createXrayClient();
await xrayClient.loadConfig(xrayConfig);
await xrayClient.start();

// 2. åˆ›å»º TUN è®¾å¤‡
const vpnConnection = vpnExt.createVpnConnection(this.context);
const tunConfig = {
  addresses: [{ address: { address: '10.0.0.2', family: 1 }, prefixLength: 24 }],
  routes: [{ interface: 'vpn-tun', destination: { address: '0.0.0.0', family: 1 }, prefixLength: 0 }],
  mtu: 1400,
  dnsAddresses: [{ address: '8.8.8.8', family: 1 }]
};
const tunFd = await vpnConnection.create(tunConfig);

// 3. å¯åŠ¨ tun2socks (é€šè¿‡è¿›ç¨‹æˆ– Native è°ƒç”¨)
// å°† tunFd ä¼ é€’ç»™ tun2socks
await startTun2Socks(tunFd, '127.0.0.1:10808', 1400);
```

## å®Œæ•´æ•°æ®æµ

```
1. HarmonyOS VpnExtensionAbility åˆ›å»º TUN è®¾å¤‡ â†’ è·å– tunFd
                                                       â†“
2. å¯åŠ¨ Xray-core (SOCKS5 å…¥ç«™åœ¨ 127.0.0.1:10808)  â†â”€â”
                                                       â”‚
3. å¯åŠ¨ tun2socks (fd://<tunFd> â†’ socks5://127.0.0.1:10808)
                                                       â”‚
4. TUN æµé‡ â†’ tun2socks â†’ Xray SOCKS5 â†’ ä»£ç†å‡ºç«™ â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯ä¼˜åŠ¿

### åˆ†ç¦»å¼æ¶æ„çš„ä¼˜åŠ¿

1. **âœ… æ— ä¾èµ–å†²çª**ï¼šè™½ç„¶ gvisor å†²çªå·²è§£å†³ï¼Œä½†åˆ†ç¦»éƒ¨ç½²æ›´çµæ´»
2. **âœ… æ¨¡å—åŒ–**ï¼šæ¯ä¸ªç»„ä»¶èŒè´£æ¸…æ™°
3. **âœ… å¯ç‹¬ç«‹å‡çº§**ï¼štun2socks å’Œ Xray-core ç‹¬ç«‹ç»´æŠ¤
4. **âœ… ç¨³å®šæ€§**ï¼šé¿å…å•ä¸€æ•…éšœç‚¹

### æ ¸å¿ƒæŠ€æœ¯ç‰¹ç‚¹

1. **Xray-core**: å¼ºå¤§çš„ä»£ç†åŠŸèƒ½å’Œåè®®æ”¯æŒ
2. **tun2socks**: é«˜æ•ˆçš„ TUN æµé‡å¤„ç†
3. **gvisor**: ç”¨æˆ·æ€ç½‘ç»œæ ˆï¼Œæ— éœ€å†…æ ¸æ”¯æŒ
4. **HarmonyOS VPN API**: åŸç”Ÿç³»ç»Ÿçº§ VPN æ”¯æŒ

## å½“å‰çŠ¶æ€

**XrayHarmony v1.251202.0**:
- âœ… Xray-core å°è£…å®Œæˆå¹¶ç¨³å®š
- âœ… æ”¯æŒæ‰€æœ‰ Xray ä»£ç†åè®®
- âœ… gvisor ä¾èµ–å†²çªå·²è§£å†³
- âš ï¸ VPN åŠŸèƒ½éœ€è¦é…åˆå¤–éƒ¨ tun2socks ä½¿ç”¨
- ğŸ“– å‚è€ƒ `examples/VPNControl_Demo` æŸ¥çœ‹ HarmonyOS VPN ä½¿ç”¨ç¤ºä¾‹

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: VPN æ— æ³•å¯åŠ¨ï¼Ÿ**
A:
1. ç¡®è®¤ Xray SOCKS5 å…¥ç«™å·²å¯åŠ¨ï¼ˆ127.0.0.1:10808ï¼‰
2. ç¡®è®¤ TUN fd æœ‰æ•ˆ
3. ç¡®è®¤ tun2socks æ­£ç¡®é…ç½®å¹¶è¿è¡Œ

**Q: éƒ¨åˆ†æµé‡æœªè¢«ä»£ç†ï¼Ÿ**
A: æ£€æŸ¥ Xray è·¯ç”±è§„åˆ™é…ç½®ï¼Œç¡®ä¿é»˜è®¤è·¯ç”±æŒ‡å‘ä»£ç†å‡ºç«™

**Q: DNS è§£æå¤±è´¥ï¼Ÿ**
A: åœ¨ Xray é…ç½®ä¸­å¯ç”¨ DNS æ¨¡å—ï¼Œæˆ–åœ¨ TUN é…ç½®ä¸­æŒ‡å®š DNS

## å‚è€ƒèµ„æº

- [Xray-core å®˜æ–¹æ–‡æ¡£](https://xtls.github.io/)
- [tun2socks GitHub](https://github.com/xjasonlyu/tun2socks)
- [gvisor é¡¹ç›®](https://github.com/google/gvisor)
- [HarmonyOS VPN API](https://developer.harmonyos.com/)
- [XrayHarmony å‡çº§è®°å½•](../UPGRADE_PLAN.md)
- [VPNControl_Demo ç¤ºä¾‹](../examples/VPNControl_Demo/)
